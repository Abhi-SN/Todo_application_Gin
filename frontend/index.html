<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gin Todo App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .completed { text-decoration: line-through; color: #9ca3af; }
        /* NEW: Styles for the loading overlay */
        #loading-overlay {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- NEW: Loading overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-xl font-semibold text-gray-700">Connecting to backend services...</p>
            <p class="text-gray-500">This may take a moment.</p>
        </div>
    </div>


    <div class="container mx-auto max-w-2xl p-4 md:p-8">
        <div class="bg-white p-8 rounded-2xl shadow-lg">
            <h1 class="text-4xl font-bold text-center mb-6 text-gray-800">My Todo List</h1>
            
            <form id="add-todo-form" class="flex gap-2 mb-6">
                <input type="text" id="new-todo-text" placeholder="What needs to be done?" required class="flex-grow px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-semibold">Add</button>
            </form>

            <ul id="todo-list" class="space-y-3">
                <!-- Todos will be rendered here by JavaScript -->
            </ul>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8083';
        const todoList = document.getElementById('todo-list');
        const addTodoForm = document.getElementById('add-todo-form');
        const newTodoText = document.getElementById('new-todo-text');
        const loadingOverlay = document.getElementById('loading-overlay');

        // --- All other functions (renderTodos, addTodoForm listener, etc.) are unchanged ---

        const renderTodos = (todos) => {
            todoList.innerHTML = '';
            if (todos.length === 0) {
                todoList.innerHTML = `<li class="text-center text-gray-500 py-4">No todos yet. Add one above!</li>`;
                return;
            }
            todos.forEach(todo => {
                const li = document.createElement('li');
                li.className = `flex items-center justify-between p-3 rounded-lg transition-all ${todo.completed ? 'bg-gray-50' : 'bg-white hover:bg-gray-50'}`;
                li.dataset.id = todo.id;
                li.dataset.text = todo.text;

                const todoContent = `
                    <span class="flex-grow cursor-pointer ${todo.completed ? 'completed' : ''}" onclick="toggleTodo(${todo.id})">
                        ${todo.text}
                    </span>
                    <div class="flex items-center gap-2">
                        <button class="text-blue-500 hover:text-blue-700 font-semibold" onclick="editTodo(this)">Edit</button>
                        <button class="text-red-500 hover:text-red-700 font-bold px-2" onclick="deleteTodo(${todo.id})">&times;</button>
                    </div>
                `;
                li.innerHTML = todoContent;
                todoList.appendChild(li);
            });
        };

        const fetchTodos = async () => {
            try {
                const response = await fetch(`${API_URL}/todos`);
                const todos = await response.json();
                renderTodos(todos);
            } catch (error) {
                console.error('Failed to fetch todos:', error);
            }
        };

        addTodoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = newTodoText.value.trim();
            if (!text) return;

            try {
                await fetch(`${API_URL}/todos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text, completed: false })
                });
                newTodoText.value = '';
                fetchTodos();
            } catch (error) {
                console.error('Failed to add todo:', error);
            }
        });

        const toggleTodo = async (id) => {
            try {
                await fetch(`${API_URL}/todos/${id}`, { method: 'PATCH' });
                fetchTodos();
            } catch (error) {
                console.error('Failed to toggle todo:', error);
            }
        };

        const deleteTodo = async (id) => {
            try {
                await fetch(`${API_URL}/todos/${id}`, { method: 'DELETE' });
                fetchTodos();
            } catch (error) {
                console.error('Failed to delete todo:', error);
            }
        };
        
        const editTodo = (editButton) => {
            const li = editButton.closest('li');
            const id = li.dataset.id;
            const originalText = li.dataset.text;

            li.innerHTML = `
                <input type="text" value="${originalText}" class="flex-grow px-2 py-1 border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500">
                <div class="flex items-center gap-2">
                    <button class="text-green-500 hover:text-green-700 font-semibold" onclick="saveTodo(${id}, this)">Save</button>
                    <button class="text-gray-500 hover:text-gray-700 font-semibold" onclick="fetchTodos()">Cancel</button>
                </div>
            `;
            li.querySelector('input').focus();
        };
        
        const saveTodo = async (id, saveButton) => {
            const li = saveButton.closest('li');
            const input = li.querySelector('input');
            const newText = input.value.trim();

            if (!newText) {
                alert("Todo text cannot be empty.");
                return;
            }

            try {
                await fetch(`${API_URL}/todos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: newText })
                });
                fetchTodos();
            } catch (error) {
                console.error('Failed to save todo:', error);
            }
        };

        // NEW: Function to check backend health before loading the app
        const checkBackendHealth = () => {
            fetch(`${API_URL}/health`)
                .then(response => {
                    if (response.ok) {
                        // If backend is healthy, hide overlay and fetch todos
                        loadingOverlay.style.opacity = '0';
                        setTimeout(() => {
                            loadingOverlay.style.display = 'none';
                        }, 500); // Wait for fade out transition
                        fetchTodos();
                    } else {
                        // If not healthy, wait and try again
                        setTimeout(checkBackendHealth, 2000);
                    }
                })
                .catch(() => {
                    // If fetch fails (e.g., network error), wait and try again
                    setTimeout(checkBackendHealth, 2000);
                });
        };

        // Initial call is now to the health check function
        checkBackendHealth();
    </script>
</body>
</html>
